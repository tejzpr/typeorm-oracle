{"version":3,"sources":["../browser/src/query-builder/relation-count/RelationCountMetadataToAttributeTransformer.ts"],"names":[],"mappings":"AAEA,OAAO,EAAC,sBAAsB,EAAC,MAAM,0BAA0B,CAAC;AAEhE;IAEI,4EAA4E;IAC5E,cAAc;IACd,4EAA4E;IAE5E,qDAAsB,aAAiC;QAAjC,kBAAa,GAAb,aAAa,CAAoB;IACvD,CAAC;IAED,4EAA4E;IAC5E,iBAAiB;IACjB,4EAA4E;IAE5E,+DAAS,GAAT;QAEI,cAAc;QACd,2BAA2B;QAC3B,wDAAwD;QACxD,8BAA8B;QAC9B,yDAAyD;QACzD,iCAAiC;QACjC,oFAAoF;QARxF,iBA8BC;QApBG,0HAA0H;QAC1H,IAAI,IAAI,CAAC,aAAa,CAAC,SAAS,EAAE;YAC9B,IAAI,CAAC,aAAa,CAAC,SAAS,CAAC,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,UAAA,aAAa;gBACtE,IAAM,SAAS,GAAG,KAAI,CAAC,mBAAmB,CAAC,KAAI,CAAC,aAAa,CAAC,SAAU,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC;gBAC9F,KAAI,CAAC,aAAa,CAAC,uBAAuB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC/D,CAAC,CAAC,CAAC;SACN;QAED,yHAAyH;QACzH,IAAI,CAAC,aAAa,CAAC,cAAc,CAAC,OAAO,CAAC,UAAA,IAAI;YAE1C,8FAA8F;YAC9F,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC,UAAU;gBAC1C,OAAO;YAEX,IAAI,CAAC,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,UAAA,aAAa;gBAC9C,IAAM,SAAS,GAAG,KAAI,CAAC,mBAAmB,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,aAAa,CAAC,CAAC;gBAC3E,KAAI,CAAC,aAAa,CAAC,uBAAuB,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YAC/D,CAAC,CAAC,CAAC;QACP,CAAC,CAAC,CAAC;IACP,CAAC;IAED,4EAA4E;IAC5E,kBAAkB;IAClB,4EAA4E;IAEpE,yEAAmB,GAA3B,UAA4B,eAAuB,EAAE,aAAoC;QACrF,OAAO,IAAI,sBAAsB,CAAC,IAAI,CAAC,aAAa,EAAE;YAClD,YAAY,EAAE,eAAe,GAAG,GAAG,GAAG,aAAa,CAAC,QAAQ,CAAC,YAAY;YACzE,aAAa,EAAE,eAAe,GAAG,GAAG,GAAG,aAAa,CAAC,YAAY;YACjE,KAAK,EAAE,aAAa,CAAC,KAAK;YAC1B,mBAAmB,EAAE,aAAa,CAAC,mBAAmB;SACzD,CAAC,CAAC;IACP,CAAC;IAEL,kDAAC;AAAD,CA1DA,AA0DC,IAAA","file":"RelationCountMetadataToAttributeTransformer.js","sourcesContent":["import {QueryExpressionMap} from \"../QueryExpressionMap\";\r\nimport {RelationCountMetadata} from \"../../metadata/RelationCountMetadata\";\r\nimport {RelationCountAttribute} from \"./RelationCountAttribute\";\r\n\r\nexport class RelationCountMetadataToAttributeTransformer {\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Constructor\r\n    // -------------------------------------------------------------------------\r\n\r\n    constructor(protected expressionMap: QueryExpressionMap) {\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Public Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    transform() {\r\n\r\n        // by example:\r\n        // post has relation count:\r\n        // @RelationCount(post => post.categories) categoryCount\r\n        // category has relation count\r\n        // @RelationCount(category => category.images) imageCount\r\n        // we load post and join category\r\n        // we expect post.categoryCount and post.category.imageCount to have relation counts\r\n\r\n        // first create relation count attributes for all relation count metadatas of the main selected object (post from example)\r\n        if (this.expressionMap.mainAlias) {\r\n            this.expressionMap.mainAlias.metadata.relationCounts.forEach(relationCount => {\r\n                const attribute = this.metadataToAttribute(this.expressionMap.mainAlias!.name, relationCount);\r\n                this.expressionMap.relationCountAttributes.push(attribute);\r\n            });\r\n        }\r\n\r\n        // second create relation count attributes for all relation count metadatas of all joined objects (category from example)\r\n        this.expressionMap.joinAttributes.forEach(join => {\r\n\r\n            // ensure this join has a metadata, because relation count can only work for real orm entities\r\n            if (!join.metadata || join.metadata.isJunction)\r\n                return;\r\n\r\n            join.metadata.relationCounts.forEach(relationCount => {\r\n                const attribute = this.metadataToAttribute(join.alias.name, relationCount);\r\n                this.expressionMap.relationCountAttributes.push(attribute);\r\n            });\r\n        });\r\n    }\r\n\r\n    // -------------------------------------------------------------------------\r\n    // Private Methods\r\n    // -------------------------------------------------------------------------\r\n\r\n    private metadataToAttribute(parentAliasName: string, relationCount: RelationCountMetadata): RelationCountAttribute {\r\n        return new RelationCountAttribute(this.expressionMap, {\r\n            relationName: parentAliasName + \".\" + relationCount.relation.propertyName, // category.images\r\n            mapToProperty: parentAliasName + \".\" + relationCount.propertyName, // category.imageIds\r\n            alias: relationCount.alias,\r\n            queryBuilderFactory: relationCount.queryBuilderFactory\r\n        });\r\n    }\r\n\r\n}"],"sourceRoot":"../.."}